Микропроцесорна схемотехника - лекции
====================================================
1. Въведение във вградените микропроцесорни системи.  
Въведение. Области на приложение. История на микропроцесорите.
Обобщена блокова схема на микропроцесорна система. Четене и запис на данни
от и в периферно устройство/памет. Фон Нойманова и Харвард архитектура - предимства 
и недостатъци. RISC и CISC микропроцесори. Класификация на процесорните елементи - стандартни логически елементи(7400, 4000), микропроцесори (uPU), програмируеми логически матрици (FPGA), специализирани интегрални схеми (ASIC), процесори с много дълга инструкция (VLIW), сигнални процесори (DSP), процесори с общо предназначение (GPP).  
2. Основи на микропроцесорите.  
Микропроцесор, микропроцесорна система, микроконтролер, микроконтролерна система - определение. 
Опростена структурна схема на микропроцесор. Фази на изпълнение на инструкцията (fetch, decode, execute, write back, memory). Детайлна структурна схема на микропроцесор. Буфери на данновата и адресната магистрала. Скаларен и суперскаларен микропроцесор - определение. Диспечер на инструкцията. Векторен и супервекторен микропроцесор - определение. Програмен модел на микропроцесора - регистри с общо предназначение (GPR), програмен брояч (PC), стеков указател (SP) /+push и pop инструкции, +стекова група/, регистър на състоянието (SR/CCR) /флагове V, N, Z, C/. Структура на микропроцесорната инструкция - код на операцията, служебни полета. Видове инструкции - според дължината на инструкцията, според вида на изпълняваната операция. Режими на адресация - регистрова, индексна, относителна /+регион за константи/, абсолютна, индиректна, индиректна автоинкрементираща /+ наставки .b и .w/, непосредствена. Класификация на микропроцесорните архитектури в зависимост от поддържаните адресации - регистър-регистър, памет-памет, регистър-памет, регистър-плюс-памет. Адресно поле, карта на паметта, обединена карта на паметта - определение. Разполагане на данните в паметта - нарастващо разполагане (little endian), намаляващо разполагане (big endian).  
3. Паралелни интерфейси.  
Класификация на интерфейсите. Разредност и посока на обмен на данните в паралелните интерфейси. Входни стъпала - изисквания, издърпващи резистори /+държач на магистрали/, тригери на Шмит, схеми за филтриране на смущения, защити по напрежение, 5-волта толерантни входове. Изходни стъпала - изисквания, противотактни и с режимен резистор, товароносимост, високоимпедансно състояние, стъпала с ОК/ОД, транслатори на нива - инвертиращи и неинвертиращи (с транзистори биполярни, MOSFET, с биполярни и MOSFET, с ценеров диод и отрицателни напрежения, с един диод, с кондензатор и противотактно стъпало), галванично разделени (с един оптрон), двупосочни (с един MOSFET). Входно-изходни модули с общо предназначение (GPIO). Формиране на имената на сигналите. Регистри на GPIO - входен, изходен, посока, флагове за прекъсвания, флагове за разрешаване на прекъсвания, избор вида на прекъсването, ниво, фронт, стръмност,  разрешаване на издърпващите резистори, избор вида на издърпващия резистор, функция /+ мултиплексиране на цифрови и аналогови изводи/. Оперативна памет SRAM - определение. Симетрични MOS транзистори и боди електрод. 6Т клетка - превключване на тригера, четящи усилватели, паразитни капацитети на BIT линията. Опростена структурна схема на SRAM. Мултиплескиране във времето на адресните и данновите сигнали, външни паралелни регистри. Времедиаграма на мултиплексиране. Оперативна памет DRAM - определение. 1Т1C клетка. 4Т клетка. 3Т клетка. 1Т клетка. Опростена структура на DRAM. Видове DRAM - SDRAM, DDR SDRAM. Времедиаграма на обмен на данни при SDR и DDR памет. DRAM контролери. Сигнали на контролера и по-важни команди. Параметри tCAS, tRCD, tRP, tRAS. Начини за опресняване на DRAM матрицата - с RAS, с CAS, скрито опресняване. Стартиране на опресняването - цялостно (burst), разпределено (distributed).  
4. Серийни асинхронни интерфейси.  
Преобразуване на паралелна в серийна информация и обратно. Разлика между асинхронен и синхронен интерфейс. Грешки от нестабилност на генератора. Наддискретизация. NRZ кодиране. Интерфейс RS232. DTE и DCE устройства. Сигнали RxD, TxD, RTS, CTS, DTR, DSR, DCD, RI. Амплитуда на логическите нива. Транслиране на нивата и галванично разделяне. UART модул. Формат на данните и проверка за грешки. UART мрежи - свободна линия и адресен бит. Автоматична детекция на скоростта. Регистри на UART модулите - входен, изходен, контролен, статус, флагове на прекъсванията и разрешаване на прекъсванията. Буфериране на данните. Грешки при обмена на информация. Интерфейс IrDA - физически слой и стандарти. Интерфейс RS485. Трансийвъри и амплитуди на логическите нива. Свързване в полу- и пълен дуплекс. Терминиране на линията и издърпващи резистори. Зависимост на скоростта на обмен от дължината на линията. Интерфейс USB. Скорост на обмен на данните. Куплунги и сигнали. Товароносимост на захранващите изводи. Схема на свързване при Low и Full Speed (LS, FS). Схема на свързване при High Speed (HS). Амплитуда на логическите нива. EYE диаграма. Видове трансфери - control, bulk, interrupt и isochronous. Свързване от типа многостепенна звезда (tiered star). Крайни точки (endpoints) - определение. Характеристики на крайните точки. Процесът зачисляване (enumeration) - основни фази. Канали за комуникация (pipes) - даннови (message pipe) и потокови (stream pipe). Дескриптори - определение. Класове драйвери. Файлов вход/изход за работа с USB устройства под Линукс. Интерфейс Ethernet. Амплитуда на логическите нива. Скорост на предаване и видове преносни среди. Кодиране на информацията при 10/100/1000. Конектор и използвани сигнали. Код на Манчестър. NRZI кодиране. MLT-3 кодиране. 4B/5B кодиране. Разбъркване на данните. Пренос на мощност по Еthernet - вариант две свободни диференциални двойки и постояннотоково отместване. Амплитуда на захранващите напрежения и мощност. MII интерфейс. Максимална дължина и скорост на обмен. OSI модел за предаване на данни в интернет. LLC, MAC и PHY слоеве. Добавяне на интернет свързаност във вградена система - LAN контролер, MII контролери, интегрирани MAC и PHY слоеве. Драйвери за Ethernet модул.  
5. Серийни синхронни интерфейси.  
Интерфейс SPI. Използвани сигнали. Режими на обмен на данните - 0, 1, 2 и 3. Последователно и паралелно свързване. Параметри на трансферите - предзакъснение, фреймово закъснение, следзакъснение, трансферно закъснение. Комуникация с периферни ИС. Галванично разделяне на SPI. SD карти. Сигнали на SD картите. Капацитет на паметта. Блокова схема на контролер на SD карта. Инициализационна процедура за работа с SPI. Поддържани команди. Четене и запис от и в SD карта. Файлова система - определение. Работа с файлове във вградена система. QSPI и DSPI интерфейси. Сигнали на QSPI и DSPI. Формат на трансферите - команда, адрес, алтернативен байт, даннови байтове. Метод за внедряване в адресното поле XIP. Интерфейс I2C. Сигнали на I2C. Примерна схема на свързване. Вътрешна структура на I2C трансийвърите. Разновидности и версии на I2C. Примерно приложение. Транслиране на нивата с MOS транзистори. Галванично разделяне на интерфейса и специализиран CMOS транслатор. Формат на трансферите - старт и стоп условие, контролен байт, бит за потвърждение. Запис и четене на данни. 7- и 10-битово адресиране. Интерфейс IEEE802.11 (Wi-Fi). Брой носещи честоти и размер на честотната лента. Стандарти a, b, g, n. Мрежи LAN, WLAN, WAN - определение. IoT устройство - определение. Мрежови процесори. Протокол TCP/IP и DHCP - основни определения. Връзка клиент-сървър. Сокети - определение. Функции за създаване, трансфер и контрол на сокети. Интерфейс Bluetooth. Честотен диапазон, скорост на обмен и обхват на Bluetooth. Брой честотни канали. Рекламиране (advertising), сканиране (scanning), свързване (connecting), съгласуване (pairing) и запаметяване (bonding). Параметри на връзката. Протокол GAP и видове устройства - маяк (broadcaster), наблюдател (observer), периферно (peripheral) и централно (central). Протокол GATT и йерархия на комуникационните точки - характеристика, сервизна функция, профил. Интерфейс IEEE 802.15.4 (Zigbee) - определение.  
6. Таймерни модули.  
Функции на таймерните модули - измерване и генериране. Софтуерни закъснения. Блокова схема на таймер с пред- и постделител. Градивни блокове на таймерите. Режими на работа на таймерите - свободно броящ (free running), измерващ (capture), генериращ (compare), ШИМ (PWM). Детайлно описание и блокови схеми на четирите режима. Ляво, дясно и средно подравнена ШИМ. Изработване на мъртво време. Стражеви таймер (Watchdog) - определение. Достъп до регистрите с парола. Системни таймери - области на приложение. Часовници за реално време (RTC) - вътрешна структура и регистри. Избор на кварцовия резонатор. Резервно захранване. Батерийно-захранвана SRAM памет. Схеми за начално установяване - BOR, POR, OST. Блокове за управление на електродвигатели. Управление на стъпкови мотори. Модули за измерване на линейно преместване (QEI, ESI).
7. Прекъсвания и директен достъп до паметта.  
Прекъсване - определение. Хендлер, вектор, векторна таблица и приоритет на прекъсване. Регистри с флагове на прекъсванията. Обслужване на прекъсване от софтуерна гледна точка. Маскируеми и немаскируеми прекъсвания. Глобално, локално и селективно разрешаване на прекъсванията. Обслужване на прекъсване от хардуерна гледна точка (етапи). Внедряване (preemption). Meханизми за обслужване на прекъсванията - верижен (tail chaining), със стеково възстановяване (pop pre-emption) и късно пристигнал (late arriving). Контролер за директен достъп до паметта (DMA). Видове DMA - със спиране на микропроцесора, с отнемане на цикли (interleaving), с паралелни трансфери. Схеми за приоритизиране на трансферите - фиксиран, с инверсия на приоритета, софтуерно зададени. Режими на прехвърляне на данните в зависимост от броя на регистрите и от вида на стартитащия сигнал. Инкрементиране и декрементиране на адресите. Софтуерни и хардуерни източници на стартиращия сигнал. Методи за понижаване на E/P. Спиране на такта. Изменяне на системната честота (DFS) и захранващото напрежение (DVS). Динамична и статична консумация. Динамично включване и изключване на периферни модули (DPM). Схеми за генериране на тактови сигнали - външни и вътрешни. Основен генератор. RC генератор. Генератор за RTC. OST таймер.  
8. Дешифрация на адресното поле.  
Карта на паметта на микропроцесорите. Обща, местна и смесена дешифрация. Пълно и непълно дешифриране. Симетрично и несиметрично дешифриране. Дешифриране на адресното поле с цифрови компаратори, памети и програмируема логика. Съпоставяне на C структури към адреси. Контрол на отделните битове (bit banding) - псевдонимни регистри (bit-band alias) и битово-контролиран регион (bit-band region). 
9. Конвейерно изпълнение на инструкцията.  
Фронтенд и бекенд модули на микропроцесора. Фази на изпълнение на инструкцията - IF, ID, EX, WR, MEM. Изпълнение без конвейер. Изпълнение с конвейер. Интермодулни буфери. Еквивалентна производителност 1 инструкция / 1 такт. Мехури в конвейера. Блокиране и зануляване на конвейера. Производителност на микропроцесора, CPI. Даннова, контролна и структурна опасност (hazard). Магистрала за забързване на операнда (operand forwarding path). Опашка от инструкции. Избягване на структурни опасности. Даннова зависимост в програмите (data dependency). Начини за зануляване на конвейера. Програмен брояч (PC) при конвейерно изпълнение. Модули за преходи (BU) - подмодул за предсказване на преходи (BPU) и подмодул за изпълнение на преходи (BEU). Целеви адрес на прехода. Статично предсказване на прехода. Динамично предсказване на прехода - таблица с история на преходите (BHT) и буфер на целеви адреси (BTB). Спекулативно изпълнение на инструкцията. Линейно изпълнение на инструкцията. Нелинейно изпълнение на инструкцията (OoO). Резервационни станции и буфер за пренареждане (ROB). Зависимост на операндите (RaW, WaR, WaW). Преименуване на регистрите.  
10. Вградени системи и аналогови сигнали.  
Класификация на сигналите - аналогови, цифрови, времево-дискретни, амплитудо-дискретни. Характеристики на ЦАП. Видове ЦАП - с резисторна матрица, със сумиране на токовете, с R-2R матрица, двоично-десетични, умножителни. Получаване на аналогово напрежение от цифров код - формула. Регистри на ЦАП - контролен, статус, статус за прекъсвания, разрешаване на прекъсвания, регистър за преобразуване. Синхронизация на два и повече ЦАП. Работа на ЦАП с DMA. Директен цифров синтез. Характеристики на АЦП. Видове АЦП - паралелен, тегловен, преброителен, сигма-делта. Получаване цифров код от аналогово напрежение - формула. Еталонно напрежение и резолюция на преобразуването. Свързване на захранващите изводи към аналоговата част в микроконтролери. Еквивалентна схема на входа на АЦП. Аналогови мултиплексори. Режими на работа на АЦП. Код на преобразуваното число. Компенсация на грешки по програмен път. Защити на входа на АЦП. Схема за задържане/запомняне и еквивалентно входно съпротивление. Модул за преобразуване на сигма-делта модулирани сигнали (DFSDM). Аналогови компаратори - мултиплексиране на изводите, избор на еталонно напрежение, изходен филтър.  
11. Дисплеи и индикация във вградените системи.  
Управление на LED светодиоди - 1 светодиод и цифрово управление на генератори на ток. Управление на 2 светодиода с 1 извод. Управление на трицветни светодиоди. Управление на 7-сегментни индикатори. статична и динамична индикация. Съпоставяне на едномерен масив и цифри. Използване на преместващи регистри. Буквено-цифрови и матрични LED индикатори. Управление на LCD дисплеи. Устройство на LCD дисплея. Видове буквено-цифрови дисплеи. Вътрешна структура на Hitachi HD44780-съвместим контролер. Сигнали на буквено-цифровите дисплеи - DB0-7, R/!W, E, RS. Регистър за инструкции и данни. Памети CGRAM и CGROM. Поддържани инструкции - основни. Задаване на яркостта на LCD. Светодиодна подсветка. Цифрово задаване на яркостта. Динамично опресняване на LCD с метода на суперпозицията. Графични LCD - основни параметри. Памет GDRAM. OLED дисплеи - структура и основни параметри. RGB интерфейс за управление. Посока на опресняване. Свързване на механични бутони и ключове към микроконтролери. Хардуерно (с кондензатор и с таймер) и софтуерно филтриране притрепването на контакта. Динамично четене на бутони от клавиатура. Използване изводите на клавиатурата за алтернативни функции посредством буфериращи инвертори. Четене на клавиатура с АЦП. Капацитивни тъч сензори - основни параметри. Метод с трансфер на заряд. Вариране на честотата (spread spectrum). Клавиатури и плъзгачи с тъч сензори. Метод с измерване на период. Ротационни енкодер - определение. Схема на свързване на ротационен енкодер. Осцилограма на изходите при завъртане наляво и надясно.  
12. Настройка и диагностика на микропроцесорни системи  
Класификация на паметите в микропроцесорните системи - програмна и даннова. ROM, PROM, EPROM, EEPROM, Flash и FRAM - принцип на действие. Разлика между NOR и NAND Flash - свързване на запаметяващите транзистори. Батерийно-подсигурена RAM (NVRAM, ZRAM). Свързване на клетките в матрица. Декодиране по ред и колона. Програматор - определение. ROM емулатор - определение. Микропроцесорен емулатор - определение. Формати на изпълнимия файл. Интерфейс JTAG. История - тестови конектори, контролни точки, гранични сканиращи клетки (BSC). TAP контролер. Регистри на TAP контролера - регистър на инструкцията, даннови регистри (BSR, BYPASS, IDCODES, BCR). Сигнали на JTAG интерфейса. Последователно свързване на ИС в JTAG верига. Език за хардуерно описание при JTAG - BSDL. JTAG дебъгери. Поддържани команди от дебъгера - program, halt, run, run to line, single step, watch. Интерфейс SWD. Сигнали на SWD интерфейса. Трасиране на програми.  
13. Модули за числа с плаваща запетая.  
Представяне на числа в двоичен вид - прав без знак (straight binary), прав код със знак (signed magnitude), обратен (one's complement) и допълнителен код (two's complement). Логическо преместване наляво/надясно. Аритметично преместване наляво/надясно. Ротиране наляво/надясно. Числа с фиксирана запетая. Числа с плаваща запетая (IEEE754-1985). Барабанен премествач (barrel shifter). Модул за числа с плаваща запетая (FPU). Видове FPU - като копроцесор, като част от скаларен и част от суперскаларен микропроцесор. Включване и използване на FPU в програма. Модул за умножение (MPY). MPY като периферен модул. Проблеми с MPY и прекъсванията. MPY като част от микропроцесорното ядро. Модул за защита на паметта (MPU) - определение. Регистри - контролен, избор на регион, базов адрес и атрибути. Разделяне на паметта на региони и подрегиони, с и без припокриване. Модул за организация на паметта (MMU) - определение. Структура на виртуалния адрес. TWU и TLB модули. Структура на TLB. Кеш памети. Видове кеш - за инструкции, за данни, припокриващи се, неприпокриващи се, мръсен и кохерентен. Нива на кеша и скорост на извличане. Кеш линия и кеш сет. Кеш събития - съвпадение (hit), пропуск (miss), невалидиране (invalidate), изчистване (clean). Регистри на кеша - за пускане, за невалидиране, за изчистване. Асоциативност на кеша - изцяло асоциативен (fully associative), директен (direct mapped), N-пътен сет-асоциативен (N-way set associative). Схеми за изтриване (replacement policy). Кеш памети и виртуални адреси на MMU.  
14. Интегрирани среди за развой.  
Системен, приложен и развоен софтуер - определения. Интегрирана развойна среда (IDE) - определение и структура. Пакет от програми за развой (toolchain). Спомагателни програми. Спомагателен софтуер (SDK) за системния софтуер. Работни полета на развойната среда. Функции на дебъг бутоните. Етапи в създаването на изпълним код. Сегменти на паметта - .text, .data, .bss, .stack и .heap. Стартиращ код. Софтуерни библиотеки - статични, динамично-заредени и динамично линкнати. Код с независима позиция (PIC). Процедурна таблица (PLT). Глобална таблица с отмествания (GOT). Дебъгване - софтуерен дебъгер, дебъг сървър и хардуерен дебъгер. Проектиране на вградени системи - нива на абстракция. Библиотеки, използвани по време на проектирането. Среда за синтез от високо ниво Daedalus.  
15. Операционни системи за реално време.  
Операционна система за реално време (RTOS) - определение. Процеси и нишки. Диспечер на ОС - определение. ОС за критично и некритично реално време (hard & soft real-time). Етапи на изпълнение на  процесите. Схеми за диспечериране - RR, PRE, RR/PRE, COOP. Комуникационни примитиви - опашки и поща. Синхронизационни примитиви - сигнали, семафори, мютекси, рандеву, бариера. Линукс за вградени системи. Структура на Линукс - файлова система, модули, мрежова комуникация, диспечер. Видове модули - в сорс дървото (in-tree), извън сорс дървото (out-of-tree). Видове драйвер - платформени, магистрални и драйвери за устройства. BIOS/UEFI програми. Дървесни двоични описания (DTB).   
